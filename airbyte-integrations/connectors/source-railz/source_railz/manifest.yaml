version: "0.1.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_pointer: ['data']
  requester:
    type: HttpRequester
    url_base: "https://api.railz.ai/"
    http_method: "GET"
    authenticator:
      class_name: source_railz.components.ShortLivedTokenAuthenticator
      url: "https://auth.railz.ai/getAccess"
      client_id: "{{ config.client_id }}"
      secret_key: "{{ config.secret_key }}"
      lifetime: "PT3600S"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "*ref(definitions.selector)"
    paginator:
      type: DefaultPaginator
      url_base: "*ref(definitions.requester.url_base)"
      page_size_option:
        inject_into: request_parameter
        field_name: "limit"
      pagination_strategy:
        type: OffsetIncrement
        page_size: 100
      page_token_option:
        inject_into: request_parameter
        field_name: "offset"
    requester:
      $ref: "*ref(definitions.requester)"

# Full Refresh Base
  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "*ref(definitions.retriever)"
  businesses_stream:
    $ref: "*ref(definitions.base_stream)"
    $options:
      name: "businesses"
      path: "/businesses"
    primary_key: "businessName"
  connections_stream:
    $ref: "*ref(definitions.base_stream)"
    $options:
      name: "connections"
      path: "/connections"
    primary_key: "connectionId"

# Internal stream for slicing
  connections_slice_stream:
    $ref: "*ref(definitions.base_stream)"
    retriever:
      $ref: "*ref(definitions.base_stream.retriever)"
      record_selector:
        $ref: "*ref(definitions.selector)"
        record_filter:
          # every stream defines in options which services it is needed
          condition: "{{ record.status in ['active', 'expired'] and record.serviceName in options.serviceNames }}"
    $options:
      name: "connections_slice"
      path: "/connections"

# Full Refresh Service
  base_service_stream:
    $ref: "*ref(definitions.base_stream)"
    retriever:
      $ref: "*ref(definitions.base_stream.retriever)"
      requester:
        $ref: "*ref(definitions.requester)"
        request_options_provider:
          request_parameters:
            businessName: "{{ stream_slice.connection.businessName }}"
            serviceName: "{{ stream_slice.connection.serviceName }}"
      stream_slicer:
        type: SubstreamSlicer
        parent_stream_configs:
          - stream: "*ref(definitions.connections_slice_stream)"
            parent_key: "/"
            stream_slice_field: "connection"
    transformations:
      - type: AddFields
        fields:
          - path: ["businessName"]
            value: "{{ stream_slice.connection.businessName }}"
          - path: ["serviceName"]
            value: "{{ stream_slice.connection.serviceName }}"

  customers_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "customers"
      path: "/customers"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "wave", "myob"]
    primary_key: "id"
  accounts_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "accounts"
      path: "/accounts"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "wave", "myob"]
    primary_key: "id"
  inventory_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "inventory"
      path: "/inventory"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "wave", "myob"]
    primary_key: "id"
  tax_rates_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "tax_rates"
      path: "/taxRates"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageIntacct", "dynamicsBusinessCentral", "wave", "myob"]
    primary_key: "id"
  tracking_categories_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "tracking_categories"
      path: "/trackingCategories"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageIntacct", "myob"]
    primary_key: "id"
  vendors_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "vendors"
      path: "/vendors"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "wave", "myob"]
    primary_key: "id"
  bank_accounts_stream:
    $ref: "*ref(definitions.base_service_stream)"
    $options:
      name: "bank_accounts"
      path: "/bankAccounts"
      serviceNames: ["plaid"]
    primary_key: "accountId"

# Incremental Service
  base_incremental_service_stream:
    $ref: "*ref(definitions.base_service_stream)"
    retriever:
      $ref: "*ref(definitions.retriever)"
      record_selector:
        $ref: "*ref(definitions.selector)"
        record_filter:
          condition: "{{ not stream_state.get(stream_slice.connection.businessName, {}).get(stream_slice.connection.serviceName) or record[options.cursor_field] >= stream_state[stream_slice.connection.businessName][stream_slice.connection.serviceName][options.cursor_field] }}"
      requester:
        $ref: "*ref(definitions.requester)"
        request_options_provider:
          request_parameters:
            businessName: "{{ stream_slice.connection.businessName }}"
            serviceName: "{{ stream_slice.connection.serviceName }}"
            startDate: "{{ format_datetime(stream_slice.start_time, '%Y-%m-%d') }}"
            endDate: "{{ format_datetime(stream_slice.end_time, '%Y-%m-%d') }}"
            orderBy: "{{ options.cursor_field }}"
      stream_slicer:
        type: CustomStreamSlicer
        class_name: source_railz.components.NestedStateCartesianProductStreamSlicer
        stream_slicers:
          - type: SubstreamSlicer
            parent_stream_configs:
              - stream: "*ref(definitions.connections_slice_stream)"
                parent_key: "/"
                stream_slice_field: "connection"
          - type: DatetimeStreamSlicer
            start_datetime:
              datetime: "{{ config['start_date'] }}"
              datetime_format: "%Y-%m-%d"
            end_datetime:
              datetime: "{{ today_utc() }}"
              datetime_format: "%Y-%m-%d"
            step: "P1M"
            datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
            cursor_granularity: "P1D"

  accounting_transactions_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "accounting_transactions"
      path: "/accountingTransactions"
      cursor_field: "postedDate"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  bank_transfers_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "bank_transfers"
      path: "/bankTransfers"
      cursor_field: "date"
      serviceNames: ["xero"]
    stream_cursor_field: "date"
    primary_key: "id"
  bills_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "bills"
      path: "/bills"
      cursor_field: "postedDate"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  bills_credit_notes_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "bills_credit_notes"
      path: "/bills/creditNotes"
      cursor_field: "postedDate"
      serviceNames: ["quickbooks", "xero", "oracleNetsuite", "sageIntacct", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  bills_payments_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "bills_payments"
      path: "/bills/payments"
      cursor_field: "date"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "myob"]
    stream_cursor_field: "date"
    primary_key: "id"
  deposits_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "deposits"
      path: "/deposits"
      cursor_field: "postedDate"
      serviceNames: ["quickbooks", "xero", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  estimates_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "estimates"
      path: "/estimates"
      cursor_field: "postedDate"
      serviceNames: ["freshbooks", "quickbooks", "xero", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  invoices_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "invoices"
      path: "/invoices"
      cursor_field: "postedDate"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "wave", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  invoices_credit_notes_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "invoices_credit_notes"
      path: "/invoices/creditNotes"
      cursor_field: "postedDate"
      serviceNames: ["freshbooks", "quickbooks", "xero", "oracleNetsuite", "sageIntacct", "dynamicsBusinessCentral", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  invoices_payments_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "invoices_payments"
      path: "/invoices/payments"
      cursor_field: "date"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "dynamicsBusinessCentral", "myob"]
    stream_cursor_field: "date"
    primary_key: "id"
  journal_entries_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "journal_entries"
      path: "/journalEntries"
      cursor_field: "postedDate"
      serviceNames: ["freshbooks", "quickbooks", "quickbooksDesktop", "xero", "oracleNetsuite", "sageBusinessCloud", "sageIntacct", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  purchase_orders_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "purchase_orders"
      path: "/purchaseOrders"
      cursor_field: "postedDate"
      serviceNames: ["quickbooks", "xero", "oracleNetsuite", "sageIntacct", "dynamicsBusinessCentral", "myob"]
    stream_cursor_field: "postedDate"
    primary_key: "id"
  refunds_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "refunds"
      path: "/refunds"
      cursor_field: "date"
      serviceNames: ["quickbooks", "xero", "myob"]
    stream_cursor_field: "date"
    primary_key: "id"
  commerce_disputes_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "commerce_disputes"
      path: "/commerce/disputes"
      cursor_field: "createdDate"
      serviceNames: ["shopify", "square", "myob"]
    stream_cursor_field: "createdDate"
    primary_key: "id"
  commerce_orders_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "commerce_orders"
      path: "/commerce/orders"
      cursor_field: "createdDate"
      serviceNames: ["shopify", "square", "myob"]
    stream_cursor_field: "createdDate"
    primary_key: "id"
  commerce_products_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "commerce_products"
      path: "/commerce/products"
      cursor_field: "createdDate"
      serviceNames: ["shopify", "square", "myob"]
    stream_cursor_field: "createdDate"
    primary_key: "id"
  commerce_transactions_stream:
    $ref: "*ref(definitions.base_incremental_service_stream)"
    $options:
      name: "commerce_transactions"
      path: "/commerce/transactions"
      cursor_field: "createdDate"
      serviceNames: ["shopify", "square", "myob"]
    stream_cursor_field: "createdDate"
    primary_key: "id"


streams:
  - "*ref(definitions.businesses_stream)"
  - "*ref(definitions.connections_stream)"
  - "*ref(definitions.customers_stream)"
  - "*ref(definitions.accounts_stream)"
  - "*ref(definitions.inventory_stream)"
  - "*ref(definitions.tax_rates_stream)"
  - "*ref(definitions.tracking_categories_stream)"
  - "*ref(definitions.vendors_stream)"
  - "*ref(definitions.bank_accounts_stream)"
  - "*ref(definitions.accounting_transactions_stream)"
  - "*ref(definitions.bank_transfers_stream)"
  - "*ref(definitions.bills_stream)"
  - "*ref(definitions.bills_credit_notes_stream)"
  - "*ref(definitions.bills_payments_stream)"
  - "*ref(definitions.deposits_stream)"
  - "*ref(definitions.estimates_stream)"
  - "*ref(definitions.invoices_stream)"
  - "*ref(definitions.invoices_credit_notes_stream)"
  - "*ref(definitions.invoices_payments_stream)"
  - "*ref(definitions.journal_entries_stream)"
  - "*ref(definitions.purchase_orders_stream)"
  - "*ref(definitions.refunds_stream)"
  - "*ref(definitions.commerce_disputes_stream)"
  - "*ref(definitions.commerce_orders_stream)"
  - "*ref(definitions.commerce_products_stream)"
  - "*ref(definitions.commerce_transactions_stream)"

check:
  stream_names:
    - "businesses"
